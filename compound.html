<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <!-- Meterial Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.1.1/dist/chart.min.js"></script>
    <title>Compound Calculator</title>
</head>

<body style="min-width: 400px;">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand" href="#">
                <div class="d-flex align-items-center"><span class="material-icons fs-1">developer_board</span>Compound
                    Calculator</div>
            </span>
            <span class="text-light fst-italic">ver 1.0</span>
        </div>
    </nav>
    <div class="container my-3 p-3 border-top border-bottom">
        <div class="row">
            <form class="col-lg-3 shadow-sm p-3 rounded" onsubmit="return onCalculate(event)">
                <div class="mb-3">
                    <label for="principal" class="form-label">Principal</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="principal" name="principal"
                            aria-describedby="principalHelp" value="5000.00" min="0.01" step=0.01>
                    </div>
                    <div id="principalHelp" class="form-text">The amount you have at initial</div>
                </div>

                <div class="mb-3">
                    <label for="apy" class="form-label">APY</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="apy" name="apy" value="500.00" min="0.01" step=0.01>
                        <span class="input-group-text">%</span>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="gas" class="form-label">Gas fee</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="gas" name="gas" aria-describedby="gasHelp"
                            value="250.00" step=0.01 min="0.01">
                    </div>
                    <div id="gasHelp" class="form-text">The fee you cost for gas for each time re-stack</div>
                </div>

                <div class="text-center"><button type="submit" class="btn btn-primary">Calculate</button></div>
            </form>
            <div class="col-lg-6">
                <canvas id="chart"></canvas>
            </div>
            <div class="col-lg-3 shadow-sm p-2 rounded">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Frequency (Days)</th>
                            <th scope="col">Value at t + 1 year</th>
                        </tr>
                    </thead>
                    <tbody id="data-table">

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="text-center"><span class="fs-6 fst-italic">author: hx8888979@ 2021</span></footer>

    <script>
        initialize();
        function onCalculate(e) {
            e.preventDefault();
            const calculator = window.calculator;
            const values = [];
            calculator.values = values;
            while (values.length > 0) values.pop();
            const formData = new FormData(e.target);
            calculator.data = {
                base: parseFloat(formData.get('principal')),
                apy: parseFloat(formData.get('apy')) / 100,
                gas: parseFloat(formData.get('gas')),
                n: 1
            };
            calculator.data.min = compound(1, calculator.data);
            while (progress());
            const maxItem = arrayMax(values);

            const dataset1 = values.slice(0, maxItem.x);
            const datasets = [{
                data: dataset1,
                radius: (ctx) => {
                    if (ctx.type !== 'data' || ctx.index < maxItem.x - 1) {
                        return 0;
                    }
                    return 5;
                },
                borderColor: 'rgb(229, 89, 119)',
                borderWidth: 4,
                backgroundColor: 'rgb(255, 177, 193)',
                fill: true,
                tension: 0.4,
                animations: { x: creatAnimation(500 / dataset1.length, true) },
            },
            {
                data: values,
                radius: 0,
                borderColor: 'rgb(70, 169, 236)',
                tension: 0.4,
                animations: { x: creatAnimation(500 / values.length) }
            }];
            window.calculator.datasets.datasets = datasets;
            calculator.chart.update();

            const low = maxItem.x - 4 < 0 ? 0 : maxItem.x - 4;
            const left = (maxItem.x - 4) < 0 ? 4 - maxItem.x : 0;
            const end = maxItem.x + 4 + left > values.length ? values.length : maxItem.x + 4 + left;
            updateTable(values.slice(low, end).reverse(), maxItem)

            return false;
        }

        function updateTable(items, maxItem) {
            const table = document.getElementById("data-table");
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            }

            for (item of items) {
                const itemRow = document.createElement("tr");
                itemRow.insertCell(0).innerText = (365 / item.x).toFixed(2);
                itemRow.insertCell(1).innerText = `$${(item.y).toFixed(2)}`;
                if (item == maxItem) {
                    itemRow.className = "table-danger";
                }
                table.appendChild(itemRow);
            }
        }

        function arrayMax(arr) {
            return arr.reduce(function (p, v) {
                return (p.y > v.y ? p : v);
            });
        }

        function creatAnimation(delayBetweenPoints, second = false) {
            const constDelay = second ? 500 : 0;
            return ({
                type: 'number',
                easing: 'linear',
                duration: delayBetweenPoints,
                from: NaN, // the point is initially skipped
                delay(ctx) {
                    if (ctx.type !== 'data' || ctx.xStarted) {
                        return 0;
                    }
                    ctx.xStarted = true;
                    return ctx.index * delayBetweenPoints + constDelay;
                }
            });
        }

        function initialize() {
            const data = {};
            const config = {
                type: 'line',
                data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 1,
                            type: 'linear',
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            min: 0,
                        }
                    },
                    plugins: {
                        legend: false,
                        tooltip: {
                            mode: 'point',
                            intersect: true
                        },
                        title: {
                            display: true,
                            text: 'Compound Value'
                        }
                    }
                }
            };

            const chart = new Chart(
                document.getElementById('chart'),
                config
            );

            window.calculator = {};
            window.calculator.datasets = data;
            window.calculator.chart = chart;
            window.addEventListener('afterprint', () => chart.resize());
        }

        function compound(frequent, data) {
            let e = data.base, i = 0;
            const d_apy = 1 + data.apy / frequent;
            const gas = data.gas;
            while (i < frequent) {
                e = e * d_apy - gas;
                if (e < 0) break;
                i += 1
            }
            return e;
        }

        function progress() {
            const data = window.calculator.data;
            const value = compound(data.n, data);
            window.calculator.values.push({
                x: data.n,
                y: value
            });
            data.n++;
            if (value < data.min || data.n > 36500)
                return false;
            else
                return true;
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
</body>

</html>